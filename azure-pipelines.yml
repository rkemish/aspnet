name: 'CI Pipeline'

trigger:
  - main

pr:
  - main

variables:
  - group: my-variable-group

stages:

  # ──────────────────────────────────────────────
  # Stage 1: Static Analysis (runs in parallel with BuildTest)
  # ──────────────────────────────────────────────
  - stage: StaticAnalysis
    displayName: Static Analysis

    jobs:
      - job: CodeAnalysis
        displayName: Roslyn Analyzers & Code Style
        pool:
          vmImage: 'ubuntu-latest'

        variables:
          solution: '**/*.sln'

        steps:
          - checkout: self

          - task: DotNetCoreCLI@2
            displayName: 'Restore'
            inputs:
              command: 'restore'
              projects: '$(solution)'

          - task: DotNetCoreCLI@2
            displayName: 'Build with Analyzers'
            inputs:
              command: 'build'
              projects: '$(solution)'
              arguments: '--configuration Release --no-restore'

          - script: dotnet format aspnet.sln --verify-no-changes --no-restore
            displayName: 'Verify Code Style (dotnet format)'

      - job: OSSVulnerabilityScan
        displayName: OSS Vulnerability & Deprecation Scan
        pool:
          vmImage: 'ubuntu-latest'

        variables:
          solution: '**/*.sln'

        steps:
          - checkout: self

          - task: DotNetCoreCLI@2
            displayName: 'Restore'
            inputs:
              command: 'restore'
              projects: '$(solution)'

          - script: |
              echo "========================================="
              echo "Checking for vulnerable packages..."
              echo "========================================="
              OUTPUT=$(dotnet list aspnet.sln package --vulnerable --include-transitive)
              echo "$OUTPUT"
              if echo "$OUTPUT" | grep -q "has the following vulnerable packages"; then
                echo "##vso[task.logissue type=error]Vulnerable packages detected"
                exit 1
              fi
            displayName: 'Check Vulnerable Packages'

          - script: |
              echo "========================================="
              echo "Checking for deprecated packages..."
              echo "========================================="
              OUTPUT=$(dotnet list aspnet.sln package --deprecated --include-transitive)
              echo "$OUTPUT"
              if echo "$OUTPUT" | grep -q "has the following deprecated packages"; then
                echo "##vso[task.logissue type=warning]Deprecated packages detected"
              fi
            displayName: 'Check Deprecated Packages'

  # ──────────────────────────────────────────────
  # Stage 2: Build and Test
  # ──────────────────────────────────────────────
  - stage: BuildTest
    displayName: Build and Test
    dependsOn: StaticAnalysis

    jobs:
      - job: BuildTest
        displayName: Build and Test Job
        pool:
          vmImage: 'ubuntu-latest'

        variables:
          solution: '**/*.sln'
          buildConfiguration: 'Release'

        steps:
          - checkout: self

          - script: echo '$(myhello)'

          - task: DotNetCoreCLI@2
            displayName: 'Restore'
            inputs:
              command: 'restore'
              projects: '$(solution)'

          - task: DotNetCoreCLI@2
            displayName: 'Build'
            inputs:
              command: 'build'
              projects: '$(solution)'
              arguments: '--configuration $(buildConfiguration)'

          - task: DotNetCoreCLI@2
            displayName: 'Run Tests'
            inputs:
              command: 'test'
              projects: '**/*Tests.csproj'
              arguments: '--configuration $(buildConfiguration) --collect:"XPlat Code Coverage" --settings aspnet.Tests/coverage.runsettings'

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish Code Coverage'
            inputs:
              summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'

          - task: DotNetCoreCLI@2
            displayName: 'Publish'
            inputs:
              command: 'publish'
              projects: 'aspnet.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
              zipAfterPublish: true

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Artifact'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)'
              artifact: 'drop'
